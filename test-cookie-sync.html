<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cookie同步测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Zotero插件Cookie同步测试</h1>
        
        <div class="test-section">
            <h3>1. 设置开发认证Cookie</h3>
            <button onclick="setDevCookie()">设置开发Cookie</button>
            <button onclick="clearDevCookie()">清除开发Cookie</button>
            <div id="cookieStatus"></div>
        </div>

        <div class="test-section">
            <h3>2. 测试Cookie传递</h3>
            <button onclick="testCookieAPI()">测试Cookie API</button>
            <button onclick="testAuthStatus()">测试认证状态</button>
            <div id="cookieTestResult"></div>
        </div>

        <div class="test-section">
            <h3>3. 测试跨域请求</h3>
            <button onclick="testWithCredentials()">测试带Cookie请求</button>
            <div id="authResult"></div>
        </div>

        <div class="test-section">
            <h3>4. 模拟Zotero插件请求</h3>
            <button onclick="simulateZoteroRequest()">模拟插件请求</button>
            <div id="zoteroResult"></div>
        </div>

        <div class="test-section">
            <h3>5. 测试日志</h3>
            <button onclick="clearLog()">清除日志</button>
            <div id="testLog" class="log"></div>
        </div>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function setDevCookie() {
            // 设置开发认证cookie
            document.cookie = 'rp_dev_auth=1; path=/; max-age=7200; SameSite=Lax';
            document.cookie = 'rp_dev_user=' + encodeURIComponent(JSON.stringify({
                username: 'testuser',
                id: 'test-123',
                email: 'test@researchopia.com'
            })) + '; path=/; max-age=7200; SameSite=Lax';

            // 验证cookie是否设置成功
            const cookies = document.cookie;
            log('设置后的Cookie: ' + cookies);

            document.getElementById('cookieStatus').innerHTML =
                '<div class="success">✅ 开发认证Cookie已设置</div>';
            log('设置开发认证Cookie成功');
        }

        function clearDevCookie() {
            document.cookie = 'rp_dev_auth=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
            document.cookie = 'rp_dev_user=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';

            document.getElementById('cookieStatus').innerHTML =
                '<div class="warning">⚠️ 开发认证Cookie已清除</div>';
            log('清除开发认证Cookie成功');
        }

        async function testCookieAPI() {
            try {
                log('开始测试Cookie传递API...');
                const response = await fetch('/api/test-cookie', {
                    method: 'GET',
                    credentials: 'include'
                });

                const data = await response.json();
                log('Cookie API响应: ' + JSON.stringify(data, null, 2));

                const resultDiv = document.getElementById('cookieTestResult');
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            ✅ Cookie传递测试成功<br>
                            检测到开发认证: ${data.cookieAnalysis.hasDevAuth ? '是' : '否'}<br>
                            检测到用户信息: ${data.cookieAnalysis.hasDevUser ? '是' : '否'}<br>
                            Cookie数量: ${data.cookieAnalysis.cookieCount}<br>
                            Origin: ${data.headers.origin}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            ❌ Cookie传递测试失败
                        </div>
                    `;
                }
            } catch (error) {
                log('Cookie API测试失败: ' + error.message);
                document.getElementById('cookieTestResult').innerHTML =
                    `<div class="error">❌ 请求失败: ${error.message}</div>`;
            }
        }

        async function testAuthStatus() {
            try {
                log('开始测试认证状态API...');
                const response = await fetch('/api/auth/status', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const data = await response.json();
                log('认证状态API响应: ' + JSON.stringify(data, null, 2));
                
                const resultDiv = document.getElementById('authResult');
                if (data.authenticated) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            ✅ 认证成功<br>
                            用户: ${data.user?.name || 'Unknown'}<br>
                            邮箱: ${data.user?.email || 'Unknown'}<br>
                            认证方式: ${data.authMethod || 'Unknown'}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            ❌ 未认证<br>
                            ${data.error ? '错误: ' + data.error : ''}
                        </div>
                    `;
                }
            } catch (error) {
                log('认证状态API测试失败: ' + error.message);
                document.getElementById('authResult').innerHTML = 
                    `<div class="error">❌ 请求失败: ${error.message}</div>`;
            }
        }

        async function testWithCredentials() {
            try {
                log('测试带Cookie的跨域请求...');
                
                // 测试不同端口
                const ports = [3000, 3001, 3002];
                for (const port of ports) {
                    try {
                        const response = await fetch(`http://localhost:${port}/api/auth/status`, {
                            method: 'GET',
                            credentials: 'include',
                            mode: 'cors'
                        });
                        
                        const data = await response.json();
                        log(`端口 ${port} 响应: ${JSON.stringify(data)}`);
                        
                        if (data.authenticated) {
                            log(`✅ 端口 ${port} 认证成功`);
                            break;
                        }
                    } catch (e) {
                        log(`❌ 端口 ${port} 连接失败: ${e.message}`);
                    }
                }
            } catch (error) {
                log('跨域请求测试失败: ' + error.message);
            }
        }

        async function simulateZoteroRequest() {
            try {
                log('模拟Zotero插件XMLHttpRequest请求...');
                
                const xhr = new XMLHttpRequest();
                xhr.withCredentials = true;
                xhr.timeout = 5000;
                
                xhr.onload = function() {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        log('Zotero模拟请求响应: ' + JSON.stringify(response, null, 2));
                        
                        const resultDiv = document.getElementById('zoteroResult');
                        if (response.authenticated) {
                            resultDiv.innerHTML = `
                                <div class="success">
                                    ✅ Zotero插件认证成功<br>
                                    用户: ${response.user?.name || 'Unknown'}<br>
                                    Token: ${response.token || 'None'}
                                </div>
                            `;
                        } else {
                            resultDiv.innerHTML = `
                                <div class="error">
                                    ❌ Zotero插件认证失败<br>
                                    ${response.error ? '错误: ' + response.error : ''}
                                </div>
                            `;
                        }
                    } catch (e) {
                        log('解析响应失败: ' + e.message);
                    }
                };
                
                xhr.onerror = function() {
                    log('❌ Zotero模拟请求网络错误');
                    document.getElementById('zoteroResult').innerHTML = 
                        '<div class="error">❌ 网络请求失败</div>';
                };
                
                xhr.ontimeout = function() {
                    log('❌ Zotero模拟请求超时');
                    document.getElementById('zoteroResult').innerHTML = 
                        '<div class="error">❌ 请求超时</div>';
                };
                
                xhr.open('GET', '/api/auth/status', true);
                xhr.send();
                
            } catch (error) {
                log('Zotero模拟请求失败: ' + error.message);
                document.getElementById('zoteroResult').innerHTML = 
                    `<div class="error">❌ 请求失败: ${error.message}</div>`;
            }
        }

        function clearLog() {
            document.getElementById('testLog').textContent = '';
        }

        // 页面加载时显示当前cookie状态
        window.onload = function() {
            const cookies = document.cookie;
            log('页面加载，当前Cookie: ' + cookies);
            
            if (cookies.includes('rp_dev_auth=1')) {
                document.getElementById('cookieStatus').innerHTML = 
                    '<div class="success">✅ 检测到开发认证Cookie</div>';
            } else {
                document.getElementById('cookieStatus').innerHTML = 
                    '<div class="warning">⚠️ 未检测到认证Cookie</div>';
            }
        };
    </script>
</body>
</html>
