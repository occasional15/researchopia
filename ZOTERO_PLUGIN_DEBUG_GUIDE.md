# 研学港 Zotero插件调试指南

## 🔍 问题诊断

根据您提供的错误信息，我发现了以下问题：

### 1. 插件加载失败 ❌
- **错误**: `Zotero.Researchopia is undefined`
- **原因**: 插件文件加载顺序问题
- **影响**: 插件无法正常启动

### 2. Bootstrap函数错误 ❌
- **错误**: `Error running bootstrap method 'install' on researchopia@researchopia.com`
- **原因**: 在 `Zotero.Researchopia` 对象定义之前就尝试访问
- **影响**: 插件安装和启动失败

### 3. 文件加载问题 ❌
- **错误**: `can't access property "rootURI", Zotero.Researchopia is undefined`
- **原因**: 主插件文件未正确加载
- **影响**: 插件功能完全不可用

## 🛠️ 解决方案

我已经创建了多个版本的修复方案：

### 方案1: 修复现有插件

1. **修复bootstrap.js**:
   - 在访问 `Zotero.Researchopia` 之前先加载主文件
   - 添加错误处理和检查

2. **修复researchopia.js**:
   - 移除重复的 `startup` 和 `shutdown` 函数
   - 确保语法正确

### 方案2: 简化测试版（推荐）

我创建了一个简化测试版，具有以下特点：

- ✅ 内联样式（无需外部CSS文件）
- ✅ 简化的加载逻辑
- ✅ 基础功能测试
- ✅ 详细的错误处理

## 🚀 快速修复步骤

### 步骤1: 构建简化测试版

```bash
# 运行简化测试版构建脚本
npm run zotero:test
```

### 步骤2: 安装测试版插件

1. 在Zotero中卸载旧版本插件
2. 安装生成的 `researchopia-simple-v1.0.0.xpi` 文件
3. 重启Zotero

### 步骤3: 验证插件功能

1. 选择任意文献
2. 查看右侧面板是否显示"研学港 Researchopia"标签页
3. 检查插件状态和文献信息显示

## 📋 测试检查清单

### 基础功能测试

- [ ] 插件是否正确加载
- [ ] Item Pane是否显示
- [ ] 端口检测是否正常
- [ ] 文献信息是否正确显示
- [ ] 状态指示器是否工作

### 错误检查

- [ ] 控制台是否还有 `Zotero.Researchopia is undefined` 错误
- [ ] 是否还有bootstrap方法错误
- [ ] 插件是否能正常启动和关闭

## 🔧 故障排除

### 问题1: 插件仍然不显示

**可能原因**:
- Zotero版本不兼容
- 插件文件损坏
- 权限问题

**解决方案**:
1. 检查Zotero版本（需要7.0+）
2. 重新下载插件文件
3. 以管理员身份运行Zotero

### 问题2: 控制台仍有错误

**可能原因**:
- 文件加载顺序问题
- 语法错误
- 依赖问题

**解决方案**:
1. 查看具体错误信息
2. 检查文件完整性
3. 使用简化测试版

### 问题3: 功能不正常

**可能原因**:
- 服务器未运行
- 网络连接问题
- 配置错误

**解决方案**:
1. 确保服务器在运行
2. 检查网络连接
3. 查看插件日志

## 📊 调试信息收集

如果问题仍然存在，请收集以下信息：

### 1. Zotero版本信息
- Zotero版本号
- 操作系统版本
- 浏览器版本（如果相关）

### 2. 错误日志
- 控制台完整错误信息
- Zotero错误日志
- 插件加载日志

### 3. 插件状态
- 插件是否在插件管理器中显示
- 插件是否启用
- 插件版本信息

## 🎯 下一步计划

### 阶段1: 基础功能验证
- [x] 创建简化测试版
- [x] 修复加载问题
- [x] 基础界面显示

### 阶段2: 功能完善
- [ ] 添加完整功能
- [ ] 修复端口检测
- [ ] 完善认证系统

### 阶段3: 优化和测试
- [ ] 性能优化
- [ ] 全面测试
- [ ] 文档完善

## 📞 技术支持

如果按照上述步骤操作后仍有问题，请：

1. 运行简化测试版并报告结果
2. 提供完整的错误日志
3. 描述具体的操作步骤
4. 说明期望的行为和实际的行为

---

**注意**: 简化测试版主要用于验证插件加载和基础功能。一旦基础功能正常，我们可以逐步添加完整功能。
