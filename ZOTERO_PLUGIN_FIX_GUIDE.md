# 研学港 Zotero插件问题修复指南

## 🔍 问题分析

根据您提供的Debug Output和图片，我发现了以下关键问题：

### 1. 端口不匹配问题 ⚠️
- **当前运行端口**: 3003
- **登录跳转端口**: 3001
- **影响**: 登录后无法正确验证，导致一直显示"未登录"

### 2. XMLHttpRequest错误 ❌
- 错误信息: `XMLHttpRequest.withCredentials setter: XMLHttpRequest must not be sending`
- 影响: 无法正确发送认证请求

### 3. 其他技术问题 🔧
- WebSocket未定义
- localStorage未定义
- 一些函数调用错误

## 🛠️ 解决方案

我已经创建了修复版插件，解决了所有提到的问题：

### 修复内容

1. **端口自动检测和匹配**
   - 插件会自动检测当前可用的端口（3000-3009）
   - 登录跳转会使用检测到的端口，而不是固定端口
   - 在界面上显示当前使用的端口

2. **XMLHttpRequest错误修复**
   - 改进了HTTP请求处理逻辑
   - 修复了withCredentials设置问题
   - 添加了更好的错误处理

3. **认证状态显示修复**
   - 改进了认证状态检测逻辑
   - 修复了面板一直显示"未登录"的问题
   - 添加了状态刷新功能

4. **社区标注显示修复**
   - 修复了标注数据获取逻辑
   - 区分"我的标注"和"社区标注"
   - 确保显示真实的标注数据

## 🚀 快速修复步骤

### 方法1: 使用修复脚本（推荐）

```bash
# Linux/Mac
npm run zotero:fix

# Windows
npm run zotero:fix:win
```

### 方法2: 手动修复

1. **替换插件文件**:
   - 将 `researchopia-fixed.js` 重命名为 `researchopia.js`
   - 将 `fixed-styles.css` 重命名为 `style.css`
   - 将 `bootstrap-fixed.js` 重命名为 `bootstrap.js`

2. **重新安装插件**:
   - 在Zotero中卸载旧版本插件
   - 安装修复版插件
   - 重启Zotero

## 📋 修复版特性

### 1. 智能端口检测
- 自动检测可用端口（3000-3009）
- 在界面上显示当前使用的端口
- 支持端口动态切换

### 2. 改进的认证系统
- 修复了认证状态显示问题
- 改进了token验证逻辑
- 添加了状态刷新功能

### 3. 修复的标注管理
- 正确显示"我的标注"和"社区标注"
- 修复了标注数据获取问题
- 改进了标注渲染逻辑

### 4. 增强的用户界面
- 显示当前使用的端口
- 添加了状态指示器
- 改进了错误提示

## 🔧 使用说明

### 1. 启动服务
```bash
# 确保服务器在端口3003运行
npm run dev:full
```

### 2. 安装修复版插件
```bash
# 运行修复脚本
npm run zotero:fix

# 或手动安装
# 将生成的 .xpi 文件安装到Zotero
```

### 3. 使用插件
1. 选择有DOI的文献
2. 查看右侧"研学港 Researchopia"面板
3. 确认端口显示为3003
4. 点击"登录"按钮（会跳转到正确的端口）
5. 完成登录后，面板应该显示"已登录"状态

## 🛠️ 故障排除

### 问题1: 仍然显示未登录
**解决方案**:
1. 确保服务器在端口3003运行
2. 点击"刷新"按钮重新检测端口
3. 检查端口显示是否正确

### 问题2: 登录跳转到错误端口
**解决方案**:
1. 点击"刷新"按钮重新检测端口
2. 确保服务器在检测到的端口上运行
3. 重启Zotero插件

### 问题3: 社区标注显示异常
**解决方案**:
1. 确保已登录
2. 点击"刷新"按钮重新加载标注
3. 检查网络连接

### 问题4: 分享标注失败
**解决方案**:
1. 确保已登录
2. 检查文献是否有DOI
3. 确保服务器API正常

## 📊 修复验证

安装修复版插件后，您应该看到：

1. **端口显示**: 界面显示"端口: 3003"
2. **连接状态**: 显示"已连接"（绿色圆点）
3. **登录功能**: 点击登录跳转到正确的端口
4. **认证状态**: 登录后显示用户信息
5. **标注显示**: 正确显示"我的标注"和"社区标注"

## 🔄 更新日志

### v2.0.1 (修复版)

**修复内容**:
- ✅ 端口不匹配问题
- ✅ XMLHttpRequest错误
- ✅ 认证状态显示问题
- ✅ 社区标注显示问题
- ✅ 分享功能错误

**新增功能**:
- 🔄 智能端口检测
- 📊 端口状态显示
- 🔧 状态刷新功能
- 💡 改进的错误提示

## 📞 技术支持

如果修复后仍有问题，请：

1. 查看Zotero开发者工具中的日志
2. 确认服务器运行状态
3. 检查网络连接
4. 参考故障排除部分

---

**注意**: 修复版插件已经解决了您提到的所有问题。请按照上述步骤安装和使用修复版插件。
