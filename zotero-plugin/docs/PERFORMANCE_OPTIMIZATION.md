# 性能优化指南

## Node.js CPU占用问题

### 问题分析
Node.js高CPU占用通常由以下原因造成：

1. **Next.js开发服务器热重载**
   - 开发模式下会监控所有文件变化
   - 自动编译和重载功能消耗CPU

2. **端口检测频率过高**
   - 插件可能频繁检测API端口
   - 多个端口的并发检测

3. **WebSocket连接维护**
   - 实时连接需要持续的CPU资源
   - 连接重试机制可能导致循环

### 解决方案

#### 1. 优化Next.js开发环境
```bash
# 使用生产模式运行（CPU占用更低）
npm run build
npm run start

# 或者限制热重载范围
# 在next.config.js中添加：
module.exports = {
  webpack: (config, { dev }) => {
    if (dev) {
      config.watchOptions = {
        poll: 1000,
        aggregateTimeout: 300,
      }
    }
    return config
  }
}
```

#### 2. 减少端口检测频率
插件已优化为：
- 只在启动时检测一次端口
- 使用1秒超时避免长时间等待
- 检测失败后不会重复检测

#### 3. 使用固定端口
在开发时使用固定端口避免检测：
```bash
# 指定端口启动
npm run dev -- -p 3000
```

#### 4. 关闭不必要的功能
- 如果不需要实时同步，可以关闭WebSocket
- 使用离线模式减少网络请求

## 插件性能优化

### 已实现的优化

1. **XMLHttpRequest替代fetch**
   - 避免AbortController兼容性问题
   - 更好的超时控制
   - 减少内存占用

2. **智能端口检测**
   - 按使用频率排序端口（3000, 3001, 3002...）
   - 快速超时机制（1秒）
   - 检测成功后立即停止

3. **离线模式优化**
   - 服务器不可用时自动切换
   - 本地处理标注数据
   - 减少网络请求

### 建议的使用方式

#### 开发环境
```bash
# 1. 启动API服务器（固定端口）
npm run dev -- -p 3000

# 2. 安装插件
# 使用最新的v0.1.9版本

# 3. 测试功能
# 插件会自动检测端口3000
```

#### 生产环境
```bash
# 1. 构建并启动生产服务器
npm run build
npm run start -- -p 3000

# 2. 配置插件使用固定地址
# 在config.js中设置apiBase: 'http://localhost:3000/api/v1'
```

## 监控和调试

### CPU使用监控
```bash
# 查看Node.js进程CPU占用
top -p $(pgrep node)

# 或使用htop
htop -p $(pgrep node)
```

### 插件调试
1. 启用Zotero调试日志
2. 查看网络请求频率
3. 监控端口检测日志

### 性能指标
- 正常情况下Node.js CPU占用应该 < 10%
- 端口检测应该在2-3秒内完成
- 标注分享响应时间 < 1秒

## 故障排除

### 高CPU占用
1. 检查是否有无限循环的网络请求
2. 确认Next.js不在热重载循环中
3. 检查WebSocket连接状态

### 端口检测失败
1. 确认API服务器正在运行
2. 检查防火墙设置
3. 尝试手动访问 http://localhost:3000/api/v1/health

### 插件连接问题
1. 查看调试日志中的错误信息
2. 确认API端点可访问
3. 检查CORS设置

## 最佳实践

1. **开发时使用固定端口**
2. **定期重启开发服务器**
3. **监控系统资源使用**
4. **及时更新插件版本**
5. **使用生产模式进行最终测试**
