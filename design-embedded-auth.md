# 嵌入式认证方案设计

## 方案A：嵌入式认证面板（推荐）

### 核心思路
在Zotero插件中嵌入一个iframe，加载研学港网站的专用认证页面，实现真正的状态共享。

### 技术架构

```
┌─────────────────────────────────────┐
│           Zotero插件                │
│  ┌─────────────────────────────────┐ │
│  │        插件UI界面               │ │
│  │  ┌─────────────────────────────┐│ │
│  │  │     嵌入式iframe            ││ │
│  │  │  https://researchopia.com/  ││ │
│  │  │  /plugin/auth               ││ │
│  │  │                             ││ │
│  │  │  [登录表单] [用户信息]      ││ │
│  │  └─────────────────────────────┘│ │
│  │                                 │ │
│  │  [同步标注] [分享标注] [设置]   │ │
│  └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

### 实现步骤

#### 1. 创建专用认证页面
在网站上创建 `/plugin/auth` 页面：
- 轻量级认证界面
- 支持登录/登出
- 显示用户信息
- 通过postMessage与插件通信

#### 2. 修改插件架构
- 移除XMLHttpRequest认证检查
- 添加iframe容器
- 实现postMessage监听
- 处理认证状态变化

#### 3. 安全通信协议
```javascript
// 插件 → iframe
{
  type: 'REQUEST_AUTH_STATUS',
  source: 'zotero-plugin'
}

// iframe → 插件
{
  type: 'AUTH_STATUS_RESPONSE',
  authenticated: true,
  user: {
    id: 'user-123',
    name: '用户名',
    email: 'user@example.com'
  },
  token: 'jwt-token',
  source: 'researchopia-auth'
}
```

### 优势
1. **真正的状态共享**：与网站完全同步
2. **安全性高**：使用网站的安全机制
3. **用户体验好**：统一的登录界面
4. **维护简单**：认证逻辑集中在网站

### 劣势
1. **需要网络连接**：离线时无法使用
2. **加载时间**：需要加载网页内容
3. **依赖网站**：网站故障影响插件

## 方案B：本地认证代理

### 核心思路
在本地启动一个认证代理服务，作为插件和网站之间的桥梁。

### 技术架构
```
浏览器 ←→ 网站认证 ←→ 本地代理服务 ←→ Zotero插件
```

### 实现方式
1. 插件启动时创建本地HTTP服务器
2. 浏览器访问特殊URL触发认证同步
3. 本地服务器获取浏览器cookie
4. 插件从本地服务器获取认证状态

### 优势
- 完全绕过Zotero限制
- 可以访问真实cookie
- 离线后仍可使用缓存状态

### 劣势
- 实现复杂度高
- 可能被防火墙阻止
- 安全风险较大

## 方案C：浏览器扩展协作

### 核心思路
开发配套的浏览器扩展，与Zotero插件协作实现认证同步。

### 技术架构
```
网站 ←→ 浏览器扩展 ←→ 本地存储/文件 ←→ Zotero插件
```

### 实现方式
1. 开发Chrome/Firefox扩展
2. 扩展监听网站认证状态变化
3. 将状态写入本地文件或注册表
4. Zotero插件读取本地状态文件

### 优势
- 真实的浏览器环境
- 完整的cookie访问权限
- 可以监听实时状态变化

### 劣势
- 需要用户安装额外扩展
- 跨平台兼容性问题
- 维护成本高

## 推荐方案：方案A（嵌入式认证面板）

### 理由
1. **技术可行性高**：利用现有web技术
2. **用户体验最佳**：无需额外安装
3. **安全性最好**：使用网站原生安全机制
4. **维护成本低**：复用现有认证系统

### 实施计划
1. **第一阶段**：创建专用认证页面
2. **第二阶段**：修改插件架构支持iframe
3. **第三阶段**：实现postMessage通信
4. **第四阶段**：优化用户体验和错误处理

### 安全改进
同时解决cookie安全问题：
1. 设置合适的cookie过期时间
2. 添加HttpOnly, Secure, SameSite标志
3. 实现会话管理和自动登出
4. 添加CSRF保护
